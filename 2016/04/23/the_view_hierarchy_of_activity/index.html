<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="ob1EA3ZBreWixpNEMzU_RH3bw_lKzvPk-6_RF8kVUfs" />










  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Android源码分析," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="前言Activity是Android中经常用到的组件，通常的用法是用startActivity方法启动一个Activity，然后在onCreate中用setContentView设置一个基本视图来显示UI。
平时我只是简单的使用这些东西来启动Activity或布局，现在我想深究一下内部这些方法内部是如何实现的。
核心代码核心代码是ActivityThread的handleResumeActivit">
<meta property="og:type" content="article">
<meta property="og:title" content="Activity的视图层次">
<meta property="og:url" content="https://bovink.com/2016/04/23/the_view_hierarchy_of_activity/index.html">
<meta property="og:site_name" content="记录点滴">
<meta property="og:description" content="前言Activity是Android中经常用到的组件，通常的用法是用startActivity方法启动一个Activity，然后在onCreate中用setContentView设置一个基本视图来显示UI。
平时我只是简单的使用这些东西来启动Activity或布局，现在我想深究一下内部这些方法内部是如何实现的。
核心代码核心代码是ActivityThread的handleResumeActivit">
<meta property="og:image" content="http://ww4.sinaimg.cn/mw690/005ZZ4X1gw1f36x0imb3tj30hq0dd75g.jpg">
<meta property="og:updated_time" content="2016-06-30T15:32:53.668Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Activity的视图层次">
<meta name="twitter:description" content="前言Activity是Android中经常用到的组件，通常的用法是用startActivity方法启动一个Activity，然后在onCreate中用setContentView设置一个基本视图来显示UI。
平时我只是简单的使用这些东西来启动Activity或布局，现在我想深究一下内部这些方法内部是如何实现的。
核心代码核心代码是ActivityThread的handleResumeActivit">
<meta name="twitter:image" content="http://ww4.sinaimg.cn/mw690/005ZZ4X1gw1f36x0imb3tj30hq0dd75g.jpg">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"hide"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> Activity的视图层次 | 记录点滴 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=55233505";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">记录点滴</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">水滴石穿 青出于蓝</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Activity的视图层次
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-04-23T00:00:00+08:00" content="2016-04-23">
              2016-04-23
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/android/" itemprop="url" rel="index">
                    <span itemprop="name">Android</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/23/the_view_hierarchy_of_activity/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/23/the_view_hierarchy_of_activity/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/04/23/the_view_hierarchy_of_activity/" class="leancloud_visitors" data-flag-title="Activity的视图层次">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Activity是Android中经常用到的组件，通常的用法是用startActivity方法启动一个Activity，然后在onCreate中用setContentView设置一个基本视图来显示UI。</p>
<p>平时我只是简单的使用这些东西来启动Activity或布局，现在我想深究一下内部这些方法内部是如何实现的。</p>
<h2 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a>核心代码</h2><p>核心代码是ActivityThread的handleResumeActivity方法中的一块：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (r.window == <span class="keyword">null</span> &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;</div><div class="line">    r.window = r.activity.getWindow();</div><div class="line">    View decor = r.window.getDecorView();</div><div class="line">    decor.setVisibility(View.INVISIBLE);</div><div class="line">    ViewManager wm = a.getWindowManager();</div><div class="line">    WindowManager.LayoutParams l = r.window.getAttributes();</div><div class="line">    </div><div class="line">    ...</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (a.mVisibleFromClient) &#123;</div><div class="line">        a.mWindowAdded = <span class="keyword">true</span>;</div><div class="line">        wm.addView(decor, l);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这块代码不算太长，但是里面东西弯弯绕绕，接下来一行一行分析下。</p>
<a id="more"></a>
<h3 id="获取Window对象"><a href="#获取Window对象" class="headerlink" title="获取Window对象"></a>获取Window对象</h3><ul>
<li>r.window = r.activity.getWindow();</li>
</ul>
<p>r是ActivityClientRecord对象，r.activity是Activity对象，r.window是Window对象。</p>
<p>调用Activity的getWindow方法返回一个Window对象，接着查看这个方法的源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Window <span class="title">getWindow</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> mWindow;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>返回Activity的私有变量mWindow，这个变量是一个抽象类Window，，这个变量在Activity的attach方法中初始化：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mWindow = <span class="keyword">new</span> PhoneWindow(<span class="keyword">this</span>);</div></pre></td></tr></table></figure></p>
<p>PhoneWindow是Window的一个子类，实现了Window中的抽象方法，在这直接使用它的构造方法赋值给mWindow。</p>
<h3 id="获取DevorView对象"><a href="#获取DevorView对象" class="headerlink" title="获取DevorView对象"></a>获取DevorView对象</h3><ul>
<li>View decor = r.window.getDecorView();</li>
</ul>
<p>很显然是调用Window类的getDecorView方法返回一个View对象，查看Window中的源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> View <span class="title">getDecorView</span><span class="params">()</span></span>;</div></pre></td></tr></table></figure></p>
<p>由于这是个抽象函数，所以实际上调用的是PhoneWindow类中的方法，继续查看PhoneWindow的源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> View <span class="title">getDecorView</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mDecor == <span class="keyword">null</span>) &#123;</div><div class="line">        installDecor();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> mDecor;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>mDecor是PhoneWindow的一个内部类DecorView的对象。当这个变量为空时，调用installDecor初始化mDecor，否则直接返回mDecor。</p>
<p>继续查看installDecor方法的源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">installDecor</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mDecor == <span class="keyword">null</span>) &#123;</div><div class="line">        mDecor = generateDecor();</div><div class="line">        </div><div class="line">        ...</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (mContentParent == <span class="keyword">null</span>) &#123;</div><div class="line">        mContentParent = generateLayout(mDecor);</div><div class="line">        </div><div class="line">        <span class="comment">// Set up decor part of UI to ignore fitsSystemWindows if appropriate.</span></div><div class="line">        mDecor.makeOptionalFitsSystemWindows();</div><div class="line">        </div><div class="line">        <span class="keyword">final</span> DecorContentParent decorContentParent = (DecorContentParent) mDecor.findViewById(</div><div class="line">                R.id.decor_content_parent);</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (decorContentParent != <span class="keyword">null</span>) &#123;</div><div class="line">        </div><div class="line">            ...</div><div class="line">            </div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mTitleView = (TextView)findViewById(R.id.title);</div><div class="line">            <span class="keyword">if</span> (mTitleView != <span class="keyword">null</span>) &#123;</div><div class="line">                </div><div class="line">                ...</div><div class="line">                </div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (mDecor.getBackground() == <span class="keyword">null</span> &amp;&amp; mBackgroundFallbackResource != <span class="number">0</span>) &#123;</div><div class="line">            mDecor.setBackgroundFallback(mBackgroundFallbackResource);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">// Only inflate or create a new TransitionManager if the caller hasn't</span></div><div class="line">        <span class="comment">// already set a custom one.</span></div><div class="line">        <span class="keyword">if</span> (hasFeature(FEATURE_ACTIVITY_TRANSITIONS)) &#123;</div><div class="line">        </div><div class="line">            ...</div><div class="line">        </div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个方法的源码较多，但是内部都是用if语句控制，通过判断我们就能找到需要了解的东西。</p>
<h4 id="初始化mDecor"><a href="#初始化mDecor" class="headerlink" title="初始化mDecor"></a>初始化mDecor</h4><p>mDecor肯定是由null变为初始值的，所有第一条if语句一定为true。</p>
<ul>
<li>mDecor = generateDecor();</li>
</ul>
<p>这行代码直接调用generateDecor方法生成DecorView对象，查看源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> DecorView <span class="title">generateDecor</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DecorView(getContext(), -<span class="number">1</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可见内部实际是用DecorView的构造函数直接返回一个DecorView对象。</p>
<h4 id="初始化mContentParent"><a href="#初始化mContentParent" class="headerlink" title="初始化mContentParent"></a>初始化mContentParent</h4><p>同样，mContentParent也是由空变为初始值的，所以这条if语句也一定为true。</p>
<ul>
<li>mContentParent = generateLayout(mDecor);</li>
</ul>
<p>调用generateLayout方法返回一个ViewGroup给mContentParent赋值，继续看源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> ViewGroup <span class="title">generateLayout</span><span class="params">(DecorView decor)</span> </span>&#123;</div><div class="line">    <span class="comment">// 根据当前的Theme应用数据</span></div><div class="line">    </div><div class="line">    TypedArray a = getWindowStyle();</div><div class="line">    </div><div class="line">    <span class="comment">// 一大串获取Theme标签值并作出反应的代码的代码</span></div><div class="line">    ...</div><div class="line">    </div><div class="line">    <span class="keyword">final</span> Context context = getContext();</div><div class="line">    <span class="comment">// 获取当前的Sdk版本</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">int</span> targetSdk = context.getApplicationInfo().targetSdkVersion;</div><div class="line">    <span class="comment">// Sdk为Android 11以前的版本</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> targetPreHoneycomb = targetSdk &lt; android.os.Build.VERSION_CODES.HONEYCOMB;</div><div class="line">    <span class="comment">// Sdk为Android 14以前的版本</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> targetPreIcs = targetSdk &lt; android.os.Build.VERSION_CODES.ICE_CREAM_SANDWICH;</div><div class="line">    <span class="comment">// Sdk为Android 21以前的版本</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> targetPreL = targetSdk &lt; android.os.Build.VERSION_CODES.LOLLIPOP;</div><div class="line">    <span class="comment">// Sdk为Android 11时需要选项菜单</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> targetHcNeedsOptions = context.getResources().getBoolean(</div><div class="line">            R.bool.target_honeycomb_needs_options_menu);</div><div class="line">    <span class="comment">// 不需要工具栏</span></div><div class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> noActionBar = !hasFeature(FEATURE_ACTION_BAR) || hasFeature(FEATURE_NO_TITLE);</div><div class="line">    <span class="comment">// 根据之前的boolean值设置需不需要响应菜单键</span></div><div class="line">    <span class="keyword">if</span> (targetPreHoneycomb || (targetPreIcs &amp;&amp; targetHcNeedsOptions &amp;&amp; noActionBar)) &#123;</div><div class="line">        setNeedsMenuKey(WindowManager.LayoutParams.NEEDS_MENU_SET_TRUE);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        setNeedsMenuKey(WindowManager.LayoutParams.NEEDS_MENU_SET_FALSE);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// 根据Theme值和相关值设置一些属性</span></div><div class="line">    ...</div><div class="line">    </div><div class="line">    <span class="comment">// 获取窗口的布局参数</span></div><div class="line">    WindowManager.LayoutParams params = getAttributes();</div><div class="line">    </div><div class="line">    <span class="comment">// 更改布局参数的一些属性</span></div><div class="line">    ...</div><div class="line">    </div><div class="line">    <span class="comment">// 当Activity不是内嵌的时候才会执行这部分，否则从container处继承相关数值。</span></div><div class="line">    <span class="comment">// 只有Activity的parent不为空时才会setContainer，简单的说不看这部分也无所谓。</span></div><div class="line">    <span class="keyword">if</span> (getContainer() == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (mBackgroundDrawable == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (mBackgroundResource == <span class="number">0</span>) &#123;</div><div class="line">                mBackgroundResource = a.getResourceId(</div><div class="line">                        R.styleable.Window_windowBackground, <span class="number">0</span>);</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (mFrameResource == <span class="number">0</span>) &#123;</div><div class="line">                mFrameResource = a.getResourceId(R.styleable.Window_windowFrame, <span class="number">0</span>);</div><div class="line">            &#125;</div><div class="line">            mBackgroundFallbackResource = a.getResourceId(</div><div class="line">                    R.styleable.Window_windowBackgroundFallback, <span class="number">0</span>);</div><div class="line">            </div><div class="line">            <span class="comment">// 这一块肯定不会进入</span></div><div class="line">            <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">                System.out.println(<span class="string">"Background: "</span></div><div class="line">                        + Integer.toHexString(mBackgroundResource) + <span class="string">" Frame: "</span></div><div class="line">                        + Integer.toHexString(mFrameResource));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        mElevation = a.getDimension(R.styleable.Window_windowElevation, <span class="number">0</span>);</div><div class="line">        mClipToOutline = a.getBoolean(R.styleable.Window_windowClipToOutline, <span class="keyword">false</span>);</div><div class="line">        mTextColor = a.getColor(R.styleable.Window_textColor, Color.TRANSPARENT);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// 设置窗口装饰，终于到了想看的地方了</span></div><div class="line">    </div><div class="line">    <span class="keyword">int</span> layoutResource;</div><div class="line">    <span class="keyword">int</span> features = getLocalFeatures();</div><div class="line">    </div><div class="line">    <span class="comment">// 一大串if-else代码根据Activity的Theme来初始化layoutResource</span></div><div class="line">    ...</div><div class="line">    </div><div class="line">    <span class="comment">// 这个方法只是简单的设置flag，字面意思就是开始变化</span></div><div class="line">    mDecor.startChanging();</div><div class="line">    </div><div class="line">    <span class="comment">// 根据layoutResource获取View</span></div><div class="line">    View in = mLayoutInflater.inflate(layoutResource, <span class="keyword">null</span>);</div><div class="line">    <span class="comment">// 将这个View添加到decor上，并填满decor</span></div><div class="line">    decor.addView(in, <span class="keyword">new</span> ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</div><div class="line">    <span class="comment">// 这个是DecorView的根内容</span></div><div class="line">    mContentRoot = (ViewGroup) in;</div><div class="line">    </div><div class="line">    <span class="comment">// 这个ViewGroup就是我们setContainView时添加到的父布局</span></div><div class="line">    ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT);</div><div class="line">    </div><div class="line">    <span class="comment">// 如果contentParent为空就会报错</span></div><div class="line">    <span class="keyword">if</span> (contentParent == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Window couldn't find content container view"</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// 几行代码，根据feature值设置相应功能</span></div><div class="line">    ...</div><div class="line">    </div><div class="line">    <span class="comment">// 剩下的设置——只是关于背景和标题——只应用于顶级窗口，即没有parent的Activity</span></div><div class="line">    <span class="keyword">if</span> (getContainer() == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">final</span> Drawable background;</div><div class="line">        <span class="keyword">if</span> (mBackgroundResource != <span class="number">0</span>) &#123;</div><div class="line">            background = getContext().getDrawable(mBackgroundResource);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            background = mBackgroundDrawable;</div><div class="line">        &#125;</div><div class="line">        mDecor.setWindowBackground(background);</div><div class="line">        </div><div class="line">        <span class="keyword">final</span> Drawable frame;</div><div class="line">        <span class="keyword">if</span> (mFrameResource != <span class="number">0</span>) &#123;</div><div class="line">            frame = getContext().getDrawable(mFrameResource);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            frame = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        mDecor.setWindowFrame(frame);</div><div class="line">        </div><div class="line">        mDecor.setElevation(mElevation);</div><div class="line">        mDecor.setClipToOutline(mClipToOutline);</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (mTitle != <span class="keyword">null</span>) &#123;</div><div class="line">            setTitle(mTitle);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> (mTitleColor == <span class="number">0</span>) &#123;</div><div class="line">            mTitleColor = mTextColor;</div><div class="line">        &#125;</div><div class="line">        setTitleColor(mTitleColor);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// 这个方法只是简单的设置flag，字面意思就是结束变化</span></div><div class="line">    mDecor.finishChanging();</div><div class="line">    </div><div class="line">    <span class="keyword">return</span> contentParent;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个方法主要是根据Window的Theme生成布局，一些代码的作用我都写在注释里了。</p>
<p>这个方法里重要的就是mContentParent和mContentRoot这两个视图。</p>
<p>mContentRoot是可能包含标题、工具条的布局，如果Theme里选择noActionBar或noTitleBar就不会有这些。</p>
<p>mContentParent是mContentRoot的子视图，在代码里用findViewById获取，id变量名是ID_ANDROID_CONTENT，点击跳转到定义发现即是com.android.internal.R.id.content。这个id在代码给出的几个布局里都是FrameLayout或者FrameLayout的子类的id。这个视图必须存在，不然会抛出异常。方法最后返回contentParent。</p>
<h4 id="设置mDecor属性"><a href="#设置mDecor属性" class="headerlink" title="设置mDecor属性"></a>设置mDecor属性</h4><ul>
<li>mDecor.makeOptionalFitsSystemWindows();</li>
</ul>
<p>这个方法是遍历mDecor的所有子视图，将它们的Flags都设为OPTIONAL_FITS_SYSTEM_WINDOWS，表示它们可以在适当的时候忽视适应系统窗口。</p>
<h4 id="获取DecorContentParent接口"><a href="#获取DecorContentParent接口" class="headerlink" title="获取DecorContentParent接口"></a>获取DecorContentParent接口</h4><ul>
<li>final DecorContentParent decorContentParent = (DecorContentParent) mDecor.findViewById(<br>R.id.decor_content_parent);</li>
</ul>
<p>DecorContentParent是一个接口类，它提供了一些关于标题或窗口的装饰方法。这里先通过id获取一个视图，再强转换成接口。</p>
<p>R.id.decor_content_parent是系统提供的一个XML文件screen_action_bar根布局ActionBarOverlayLayout的id，这个XML文件在之前的generateLayout方法里用到过。如果用户不使用ActionBar功能，这个接口就为空。</p>
<p>之所以这里选择转换成接口，是因为当我们选择自定义ActionBar时，就能针对接口编程，而不用针对实现编程。</p>
<h4 id="判断decorContentParent是否为空"><a href="#判断decorContentParent是否为空" class="headerlink" title="判断decorContentParent是否为空"></a>判断decorContentParent是否为空</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (decorContentParent != <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="comment">// 如果decorContentParent不为空，则使用decorContentParent设置标题、</span></div><div class="line">    <span class="comment">// 回调方法、icon、logo等</span></div><div class="line">    ...</div><div class="line">    </div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// 获取标题</span></div><div class="line">    mTitleView = (TextView)findViewById(R.id.title);</div><div class="line">    <span class="comment">// 如果标题不为空</span></div><div class="line">    <span class="keyword">if</span> (mTitleView != <span class="keyword">null</span>) &#123;</div><div class="line">        mTitleView.setLayoutDirection(mDecor.getLayoutDirection());</div><div class="line">        <span class="comment">// 如果设置不显示标题</span></div><div class="line">        <span class="keyword">if</span> ((getLocalFeatures() &amp; (<span class="number">1</span> &lt;&lt; FEATURE_NO_TITLE)) != <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// 获取标题容器</span></div><div class="line">            View titleContainer = findViewById(</div><div class="line">                    R.id.title_container);</div><div class="line">            <span class="comment">// 如果容器不为空，则标题容器Visibility设为GONE</span></div><div class="line">            <span class="keyword">if</span> (titleContainer != <span class="keyword">null</span>) &#123;</div><div class="line">                titleContainer.setVisibility(View.GONE);</div><div class="line">                </div><div class="line">            <span class="comment">// 如果容器为空，则直接将标题Visibility设为GONE</span></div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                mTitleView.setVisibility(View.GONE);</div><div class="line">            &#125;</div><div class="line">            <span class="comment">// 如果mContentParent是FrameLayout类型，</span></div><div class="line">            <span class="comment">// 则将其前景设为空</span></div><div class="line">            <span class="keyword">if</span> (mContentParent <span class="keyword">instanceof</span> FrameLayout) &#123;</div><div class="line">                ((FrameLayout)mContentParent).setForeground(<span class="keyword">null</span>);</div><div class="line">            &#125;</div><div class="line">        </div><div class="line">        <span class="comment">// 设置标题</span></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mTitleView.setText(mTitle);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当decorContentParent不为空时，使用decorContentParent实现相关设置。</p>
<h4 id="设置默认背景"><a href="#设置默认背景" class="headerlink" title="设置默认背景"></a>设置默认背景</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (mDecor.getBackground() == <span class="keyword">null</span> &amp;&amp; mBackgroundFallbackResource != <span class="number">0</span>) &#123;</div><div class="line">    mDecor.setBackgroundFallback(mBackgroundFallbackResource);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>mBackgroundFallbackResource是从Theme中获取的，可以自己设置，默认值为0。当mDecor的背景为空且mBackgroundFallbackResource不为0时，mDecor设置后补背景。</p>
<h4 id="设置转场相关变量"><a href="#设置转场相关变量" class="headerlink" title="设置转场相关变量"></a>设置转场相关变量</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 如果设置存在转场功能</span></div><div class="line"><span class="keyword">if</span> (hasFeature(FEATURE_ACTIVITY_TRANSITIONS)) &#123;</div><div class="line">    <span class="comment">// 直接获取Theme设定值或者直接new一个对象</span></div><div class="line">    <span class="keyword">if</span> (mTransitionManager == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">int</span> transitionRes = getWindowStyle().getResourceId(</div><div class="line">                R.styleable.Window_windowContentTransitionManager,</div><div class="line">                <span class="number">0</span>);</div><div class="line">        <span class="keyword">if</span> (transitionRes != <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">final</span> TransitionInflater inflater = TransitionInflater.from(getContext());</div><div class="line">            mTransitionManager = inflater.inflateTransitionManager(transitionRes,</div><div class="line">                    mContentParent);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            mTransitionManager = <span class="keyword">new</span> TransitionManager();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// 根据Theme的设置初始化一些Transition类对象，以及相关变量</span></div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>如果mTransitionManager为空则或去Theme中相应的设置值，如果为0则直接new一个新对象。</p>
<h3 id="设定decor的Visibility"><a href="#设定decor的Visibility" class="headerlink" title="设定decor的Visibility"></a>设定decor的Visibility</h3><p>绕了一大圈，获得的最重要的信息就是mDecor内部是怎么布局的。</p>
<p>mDecor有一个子视图mContentRoot，而mContentRoot又有一个子视图mContentParent，而这个mContentPanrent就是用Activity的setContentView时添加视图的父节点。</p>
<p>现在回到核心代码：</p>
<ul>
<li>decor.setVisibility(View.INVISIBLE);</li>
</ul>
<p>setVisibility有View类实现，将decor设为INVISIBLE。</p>
<h3 id="获取ViewManager接口实例"><a href="#获取ViewManager接口实例" class="headerlink" title="获取ViewManager接口实例"></a>获取ViewManager接口实例</h3><ul>
<li>ViewManager wm = a.getWindowManager();</li>
</ul>
<p>调用Activity的getWindowManager方法返回一个ViewManager实例，查看源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Retrieve the window manager for showing custom windows. */</span></div><div class="line"><span class="function"><span class="keyword">public</span> WindowManager <span class="title">getWindowManager</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> mWindowManager;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>直接返回Activity的一个变量mWindowManager，而这个变量在Activity的attach方法中被初始化：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ActivityThread aThread,</span></span></div><div class="line">        Instrumentation instr, IBinder token, <span class="keyword">int</span> ident,</div><div class="line">        Application application, Intent intent, ActivityInfo info,</div><div class="line">        CharSequence title, Activity parent, String id,</div><div class="line">        NonConfigurationInstances lastNonConfigurationInstances,</div><div class="line">        Configuration config, String referrer, IVoiceInteractor voiceInteractor) &#123;</div><div class="line">    </div><div class="line">    ...</div><div class="line">    </div><div class="line">    mWindow = <span class="keyword">new</span> PhoneWindow(<span class="keyword">this</span>);</div><div class="line">    </div><div class="line">    ...</div><div class="line">    </div><div class="line">    mWindow.setWindowManager(</div><div class="line">            (WindowManager)context.getSystemService(Context.WINDOW_SERVICE),</div><div class="line">            mToken, mComponent.flattenToString(),</div><div class="line">            (info.flags &amp; ActivityInfo.FLAG_HARDWARE_ACCELERATED) != <span class="number">0</span>);</div><div class="line">    <span class="keyword">if</span> (mParent != <span class="keyword">null</span>) &#123;</div><div class="line">        mWindow.setContainer(mParent.getWindow());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    mWindowManager = mWindow.getWindowManager();</div><div class="line">   </div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>mWindowManager在这里是用mWindow的getWindowManager方法初始化，这个方法由Window类实现，查看源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Return the window manager allowing this Window to display its own</div><div class="line"> * windows.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> WindowManager The ViewManager.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> WindowManager <span class="title">getWindowManager</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> mWindowManager;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>还是直接返回Window类的私有变量mWindowManager，而这个变量是用Window类的setWindowManager初始化的，可以看到之前出现的attach方法中，mWindow变量已经用setWindowManager初始化了，查看setWindowManager的源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setWindowManager</span><span class="params">(WindowManager wm, IBinder appToken, String appName,</span></span></div><div class="line">        <span class="keyword">boolean</span> hardwareAccelerated) &#123;</div><div class="line">    mAppToken = appToken;</div><div class="line">    mAppName = appName;</div><div class="line">    mHardwareAccelerated = hardwareAccelerated</div><div class="line">            || SystemProperties.getBoolean(PROPERTY_HARDWARE_UI, <span class="keyword">false</span>);</div><div class="line">    <span class="keyword">if</span> (wm == <span class="keyword">null</span>) &#123;</div><div class="line">        wm = (WindowManager)mContext.getSystemService(Context.WINDOW_SERVICE);</div><div class="line">    &#125;</div><div class="line">    mWindowManager = ((WindowManagerImpl)wm).createLocalWindowManager(<span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="分析wm参数具体类型"><a href="#分析wm参数具体类型" class="headerlink" title="分析wm参数具体类型"></a>分析wm参数具体类型</h4><p>本来在这里直接查看WindowManagerImpl的createLocalWindowManager方法就行了，但是还是想深究一下wm为什么能被强制转换成WindowManagerImpl类型，免得以后忘了又要重新看代码。</p>
<p>参数wm即前面传入的(WindowManager)context.getSystemService(Context.Window_SERVICE)，而context是attach方法的参数，这个方法在ActivityThread的performLaunchActivity中被调用：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</div><div class="line">                r.ident, app, r.intent, r.activityInfo, title, r.parent,</div><div class="line">                r.embeddedID, r.lastNonConfigurationInstances, config,</div><div class="line">                r.referrer, r.voiceInteractor);</div></pre></td></tr></table></figure></p>
<p>这里的appContext即传入的参数，这个参数同样是在performLaunchActivity中初始化：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Context appContext = createBaseContextForActivity(r, activity);</div></pre></td></tr></table></figure></p>
<p>继续看createBaseContextForActivity的源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Context <span class="title">createBaseContextForActivity</span><span class="params">(ActivityClientRecord r, <span class="keyword">final</span> Activity activity)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> displayId = Display.DEFAULT_DISPLAY;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        displayId = ActivityManagerNative.getDefault().getActivityDisplayId(r.token);</div><div class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    ContextImpl appContext = ContextImpl.createActivityContext(</div><div class="line">            <span class="keyword">this</span>, r.packageInfo, displayId, r.overrideConfig);</div><div class="line">    appContext.setOuterContext(activity);</div><div class="line">    Context baseContext = appContext;</div><div class="line">    </div><div class="line">    <span class="keyword">final</span> DisplayManagerGlobal dm = DisplayManagerGlobal.getInstance();</div><div class="line">    <span class="comment">// For debugging purposes, if the activity's package name contains the value of</span></div><div class="line">    <span class="comment">// the "debug.use-second-display" system property as a substring, then show</span></div><div class="line">    <span class="comment">// its content on a secondary display if there is one.</span></div><div class="line">    String pkgName = SystemProperties.get(<span class="string">"debug.second-display.pkg"</span>);</div><div class="line">    <span class="keyword">if</span> (pkgName != <span class="keyword">null</span> &amp;&amp; !pkgName.isEmpty()</div><div class="line">            &amp;&amp; r.packageInfo.mPackageName.contains(pkgName)) &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> id : dm.getDisplayIds()) &#123;</div><div class="line">            <span class="keyword">if</span> (id != Display.DEFAULT_DISPLAY) &#123;</div><div class="line">                Display display =</div><div class="line">                        dm.getCompatibleDisplay(id, appContext.getDisplayAdjustments(id));</div><div class="line">                baseContext = appContext.createDisplayContext(display);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> baseContext;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>里面代码还是有点多，只需要抓重点就行了。这个方法最后返回baseContext，这个变量在方法中使用appContext初始化，而appContext的类型是ContextImpl类，一个Context的子类，实现了抽象类Context中的方法。所以很明显，前面调用Context的抽象方法getSystemService就是调用ContextImpl的getSystemService方法。</p>
<p>查看ContextImpl源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getSystemService</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> SystemServiceRegistry.getSystemService(<span class="keyword">this</span>, name);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>发现内部是调用SystemServiceRegistry的一个静态方法，继续看源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getSystemService</span><span class="params">(ContextImpl ctx, String name)</span> </span>&#123;</div><div class="line">    ServiceFetcher&lt;?&gt; fetcher = SYSTEM_SERVICE_FETCHERS.get(name);</div><div class="line">    <span class="keyword">return</span> fetcher != <span class="keyword">null</span> ? fetcher.getService(ctx) : <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>SYSTEM_SERVICE_FETCHERS是一个哈希表，key为String类型,value是一个接口ServiceFetcher&lt;?&gt;，这里直接用get方法初始化fetcher。既然有get，那肯定有put。继续在SystemServiceRegistry里Ctrl+F寻找，发现了这个方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">registerService</span><span class="params">(String serviceName, Class&lt;T&gt; serviceClass,</span></span></div><div class="line">        ServiceFetcher&lt;T&gt; serviceFetcher) &#123;</div><div class="line">    SYSTEM_SERVICE_NAMES.put(serviceClass, serviceName);</div><div class="line">    SYSTEM_SERVICE_FETCHERS.put(serviceName, serviceFetcher);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>第一条语句是将服务类和服务名放入一个哈希表，第二条语句则是将服务名和接口类ServiceFetcher<t>。这个方法在SystemServiceRegistry里静态调用，注册了大量服务。根据前面传入的参数可知nama为Context.WINDOW_SERVICE。继续Ctrl+F搜一下，就找到了相应的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">registerService(Context.WINDOW_SERVICE, WindowManager.class,</div><div class="line">            <span class="keyword">new</span> CachedServiceFetcher&lt;WindowManager&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> WindowManager <span class="title">createService</span><span class="params">(ContextImpl ctx)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WindowManagerImpl(ctx.getDisplay());</div><div class="line">    &#125;&#125;);</div></pre></td></tr></table></figure></t></p>
<p>这里面CachedServiceFetcher<windowmanager>实现了ServiceFetcher<t>接口，查看它的源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CachedServiceFetcher</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">ServiceFetcher</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> mCacheIndex;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CachedServiceFetcher</span><span class="params">()</span> </span>&#123;</div><div class="line">        mCacheIndex = sServiceCacheSize++;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> T <span class="title">getService</span><span class="params">(ContextImpl ctx)</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> Object[] cache = ctx.mServiceCache;</div><div class="line">        <span class="keyword">synchronized</span> (cache) &#123;</div><div class="line">            <span class="comment">// Fetch or create the service.</span></div><div class="line">            Object service = cache[mCacheIndex];</div><div class="line">            <span class="keyword">if</span> (service == <span class="keyword">null</span>) &#123;</div><div class="line">                service = createService(ctx);</div><div class="line">                cache[mCacheIndex] = service;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> (T)service;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> T <span class="title">createService</span><span class="params">(ContextImpl ctx)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></t></windowmanager></p>
<p>根据getSystemService方法、registerService传入的参数和CachedServiceFetcher<windowmanager>的内部实现可以知道，getService返回的就是createService创建的新对象WindowManagerImpl类，这样就能理解为什么最开始WindowManager类型的wm能强制转换成WindowManagerImpl了，因为传入的参数实际就是WindowManagerImpl类，而这个类本身就实现了WindowManager接口。</windowmanager></p>
<h4 id="初始化mWindowManager"><a href="#初始化mWindowManager" class="headerlink" title="初始化mWindowManager"></a>初始化mWindowManager</h4><p>回到正题。</p>
<p>mWindowManager是WindowManager类对象，而WindowManager是ViewManager的子类，所以mWindowManager可以直接当ViewManager使用。</p>
<ul>
<li>mWindowManager = ((WindowManagerImpl)wm).createLocalWindowManager(this);</li>
</ul>
<p>这里使用WindowManagerImpl的createLocalWindowManager方法初始化mWindowManager，查看源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> WindowManagerImpl <span class="title">createLocalWindowManager</span><span class="params">(Window parentWindow)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> WindowManagerImpl(mDisplay, parentWindow);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个方法使用wm自身的mDisplay参数和传入的Window参数创建了一个新的WindowManagerImpl对象。所以mWindowManager实际就是WindowManagerImpl的实现的接口类。这样就清楚最开始获取的ViewManager变量实际指向的是哪个类了。</p>
<h3 id="获取窗口布局参数"><a href="#获取窗口布局参数" class="headerlink" title="获取窗口布局参数"></a>获取窗口布局参数</h3><ul>
<li>WindowManager.LayoutParams l = r.window.getAttributes();</li>
</ul>
<p>这里调用的是Window类的getAttributes方法，查看源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> WindowManager.<span class="function">LayoutParams <span class="title">getAttributes</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> mWindowAttributes;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>直接返回私有变量mWindowAttributes,这个参数即当前窗口的布局参数。它在Window类内部直接被初始化：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">    // The current window attributes.</div><div class="line">    private final WindowManager.LayoutParams mWindowAttributes =</div><div class="line">        new WindowManager.LayoutParams();</div><div class="line">```        </div><div class="line">### 添加视图</div><div class="line">```java</div><div class="line">    if (a.mVisibleFromClient) &#123;</div><div class="line">        a.mWindowAdded = true;</div><div class="line">        wm.addView(decor, l);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>mVisibleFromClien是一个布尔值，在Activity类能通过setVisible方法修改，在performCreateCommon中也会被修改，默认值是true。</p>
<p>a.mWindowAdded设为true，表示Activity已经添加了Window。</p>
<p>接下来才是真正的添加窗口，调用的addView已经知道实际调用的是WindowManagerImpl的方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(@NonNull View view, @NonNull ViewGroup.LayoutParams params)</span> </span>&#123;</div><div class="line">    applyDefaultToken(params);</div><div class="line">    mGlobal.addView(view, params, mDisplay, mParentWindow);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里内部继续转交给mGlobal去添加视图，mGlobal是WindowManagerGlobal类对象，查看它的addView方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params,</span></span></div><div class="line">        Display display, Window parentWindow) &#123;</div><div class="line">    </div><div class="line">    ...</div><div class="line">    </div><div class="line">    <span class="keyword">final</span> WindowManager.LayoutParams wparams = (WindowManager.LayoutParams) params;</div><div class="line">    </div><div class="line">    ...</div><div class="line">    </div><div class="line">    ViewRootImpl root;</div><div class="line">    </div><div class="line">    ...</div><div class="line">    </div><div class="line">    <span class="keyword">synchronized</span> (mLock) &#123;</div><div class="line">    ...</div><div class="line">    </div><div class="line">        root = <span class="keyword">new</span> ViewRootImpl(view.getContext(), display);</div><div class="line">        </div><div class="line">        view.setLayoutParams(wparams);</div><div class="line">        </div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// do this last because it fires off messages to start doing things</span></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        root.setView(view, wparams, panelParentView);</div><div class="line">    &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line">        <span class="comment">// BadTokenException or InvalidDisplayException, clean up.</span></div><div class="line">        <span class="keyword">synchronized</span> (mLock) &#123;</div><div class="line">            <span class="keyword">final</span> <span class="keyword">int</span> index = findViewLocked(view, <span class="keyword">false</span>);</div><div class="line">            <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</div><div class="line">                removeViewLocked(index, <span class="keyword">true</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">throw</span> e;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>先将params重新转换成WindowManager.LayoutParams，之后view就是用这个布局参数。创建一个ViewRootImpl对象，然后使用setView方法，查看源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setView</span><span class="params">(View view, WindowManager.LayoutParams attrs, View panelParentView)</span> </span>&#123;</div><div class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (mView == <span class="keyword">null</span>) &#123;</div><div class="line">            mView = view;</div><div class="line">           </div><div class="line">           ...</div><div class="line">           </div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其他的暂不关注，这里直接用view赋值给ViewRootImpl的默认变量mView，从而使DecorView与ViewRootImpl有了联系。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>在前面一直说setContentView就是将View添加到mContentParent上，现在简单分析下。首先得看Activity的setContentView的源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">    getWindow().setContentView(view);</div><div class="line">    initWindowDecorActionBar();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在里面直接调用getWindow获取PhoneWindow对象，然后调用其setContentView方法，为什么是PhoneWindow前面已经说了。PhoneWindow的setContentView源码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">    setContentView(view, <span class="keyword">new</span> ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>继续调用PhoneWindow内部重载的另一个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContentView</span><span class="params">(View view, ViewGroup.LayoutParams params)</span> </span>&#123;</div><div class="line">    </div><div class="line">    ...</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</div><div class="line">        view.setLayoutParams(params);</div><div class="line">        <span class="keyword">final</span> Scene newScene = <span class="keyword">new</span> Scene(mContentParent, view);</div><div class="line">        transitionTo(newScene);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        mContentParent.addView(view, params);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在这里我们可以很明显发现一个语句mContentPanrent.addView(view, params)，这里addView是用ViewGroup实现的，params的两个参数都是MATCH_PARENT，view就是我们需要添加的UI界面了。</p>
<p>这里分析的else分支，if分支最终应该也是这样的。当然setContetView的另一个使用资源id作参数的重载方法最终也是这样，就不分析了。</p>
<p>最后用图表示各个视图之间的关系：</p>
<p><img src="http://ww4.sinaimg.cn/mw690/005ZZ4X1gw1f36x0imb3tj30hq0dd75g.jpg" alt=""></p>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/analyze-android-source-code/" rel="tag">#Android源码分析</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/04/02/translation_of_the_most_valuable_lesson_i_learned_from_playing_the_violin/" rel="next" title="我从小提琴学习中学到的最有价值的一课">
                <i class="fa fa-chevron-left"></i> 我从小提琴学习中学到的最有价值的一课
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/07/01/use_vim_to_write_markdown/" rel="prev" title="用Vim编辑Markdown并预览效果">
                用Vim编辑Markdown并预览效果 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <div class="ds-share flat" data-thread-key="2016/04/23/the_view_hierarchy_of_activity/"
     data-title="Activity的视图层次"
     data-content=""
     data-url="https://bovink.com/2016/04/23/the_view_hierarchy_of_activity/">
  <div class="ds-share-inline">
    <ul  class="ds-share-icons-16">

      <li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
      <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
      <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li>
      <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">腾讯微博</a></li>
      <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>

    </ul>
    <div class="ds-share-icons-more">
    </div>
  </div>
</div>
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/04/23/the_view_hierarchy_of_activity/"
           data-title="Activity的视图层次" data-url="https://bovink.com/2016/04/23/the_view_hierarchy_of_activity/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="文章感" />
          <p class="site-author-name" itemprop="name">文章感</p>
          <p class="site-description motion-element" itemprop="description">享受技术 享受生活</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">12</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/bovink" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/u/5496577699" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#核心代码"><span class="nav-number">2.</span> <span class="nav-text">核心代码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#获取Window对象"><span class="nav-number">2.1.</span> <span class="nav-text">获取Window对象</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取DevorView对象"><span class="nav-number">2.2.</span> <span class="nav-text">获取DevorView对象</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#初始化mDecor"><span class="nav-number">2.2.1.</span> <span class="nav-text">初始化mDecor</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#初始化mContentParent"><span class="nav-number">2.2.2.</span> <span class="nav-text">初始化mContentParent</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置mDecor属性"><span class="nav-number">2.2.3.</span> <span class="nav-text">设置mDecor属性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#获取DecorContentParent接口"><span class="nav-number">2.2.4.</span> <span class="nav-text">获取DecorContentParent接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#判断decorContentParent是否为空"><span class="nav-number">2.2.5.</span> <span class="nav-text">判断decorContentParent是否为空</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置默认背景"><span class="nav-number">2.2.6.</span> <span class="nav-text">设置默认背景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#设置转场相关变量"><span class="nav-number">2.2.7.</span> <span class="nav-text">设置转场相关变量</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设定decor的Visibility"><span class="nav-number">2.3.</span> <span class="nav-text">设定decor的Visibility</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取ViewManager接口实例"><span class="nav-number">2.4.</span> <span class="nav-text">获取ViewManager接口实例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#分析wm参数具体类型"><span class="nav-number">2.4.1.</span> <span class="nav-text">分析wm参数具体类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#初始化mWindowManager"><span class="nav-number">2.4.2.</span> <span class="nav-text">初始化mWindowManager</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获取窗口布局参数"><span class="nav-number">2.5.</span> <span class="nav-text">获取窗口布局参数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2016 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">文章感</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"bovink"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("NiOlLWkSYVl4xgfhv2JHCJul-gzGzoHsz", "6GEABp5OEd4VqhmTzTPvV9I3");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

</body>
</html>
